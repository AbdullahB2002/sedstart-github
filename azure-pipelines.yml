trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: sedstart-secrets  # Contains your GITHUB_PAT

steps:
  - task: Bash@3
    displayName: 'Dispatch Sedstart Prod Workflow on GitHub'
    inputs:
      targetType: 'inline'
      script: |
        echo "Dispatching workflow: manual.yml on branch main"

        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "https://api.github.com/repos/AbdullahB2002/sedstart-github/actions/workflows/manual.yml/dispatches" \
          -H "Authorization: token $(GITHUB_PAT)" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          -d '{
            "ref": "main"
          }')

        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        echo "##[section]GitHub Dispatch Response (HTTP $HTTP_CODE):"
        echo "$BODY"

        if [ "$HTTP_CODE" -eq 204 ]; then
          echo "✅ Success! Sedstart Prod workflow (manual.yml) dispatched successfully!"
          echo "Check your GitHub Actions run here:"
          echo "https://github.com/AbdullahB2002/sedstart-github/actions"
        else
          echo "❌ Dispatch failed (HTTP $HTTP_CODE)"
          echo "Double-check:"
          echo "   - GITHUB_PAT is a classic token with 'repo' scope"
          echo "   - File is exactly 'manual.yml' on 'main' branch"
          exit 1
        fi
    env:
      GITHUB_PAT: $(GITHUB_PAT)